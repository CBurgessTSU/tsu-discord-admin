<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.png" sizes="any">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <title>TSU Discord Class Manager</title>
</head>
<body>
    <div class="container">
        <img src="tsu_logo.png" alt="TSU Logo" class="logo">
        <h1 style="text-align: center;">Discord Class Manager</h1>
        <p class="subtitle">Manage Discord classes and role assignments</p>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="create">Create New Class</button>
            <button class="tab" data-tab="existing">Existing Role Link</button>
        </div>

        <!-- Tab 1: Create New Class -->
        <div class="tab-panel active" id="createPanel">
            <!--div class="section-title">Create New Class</div>-->
            <div class="section-subtitle">Create a new Discord category, channel, and role with permissions assigned automatically. Also generates a join link for students to click.</div>

            <form id="classForm">
            <div class="form-group">
                <label class="input-label" for="className">Class Name</label>
                <div class="input-wrapper">
                    <input
                        type="text"
                        id="className"
                        name="className"
                        placeholder="e.g., Options 201"
                        required
                        autocomplete="off"
                    >
                    <div class="validation-message" id="validationMessage">
                        Only letters, numbers, spaces, hyphens, and underscores are allowed
                    </div>
                </div>
                <div id="namePreview" style="display: none; margin-top: 12px; font-size: 14px; color: rgba(255, 255, 255, 0.7);">
                    <div style="margin-bottom: 6px;"><strong>Discord resources that will be created:</strong></div>
                    <div style="margin-left: 8px; line-height: 1.6;">
                        <div>Category: <span id="categoryPreview" style="color: rgba(255, 255, 255, 0.9); font-weight: 500;"></span></div>
                        <div>Channel: <span id="channelPreview" style="color: rgba(255, 255, 255, 0.9); font-weight: 500;"></span></div>
                        <div>Role: <span id="rolePreview" style="color: rgba(255, 255, 255, 0.9); font-weight: 500;"></span></div>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn" disabled>
                <span id="btnText">Create Discord Channel</span>
                <span id="btnSpinner" class="spinner" style="display: none;"></span>
            </button>
        </form>

        <div id="result" class="result"></div>
        </div>

        <!-- Tab 2: Existing Role Link -->
        <div class="tab-panel" id="existingPanel">
            <!--div class="section-title">Generate Link for Existing Role</div>-->
            <div class="section-subtitle">Create a join link for students to access an existing class</div>

            <div class="form-group">
            <label class="input-label" for="roleSelect">Select Role</label>
            <div class="custom-select disabled" id="customSelect">
                <div class="select-display" id="selectDisplay">
                    <span id="selectedRoleText">Loading roles...</span>
                    <span class="select-arrow">‚ñº</span>
                </div>
                <div class="select-options" id="selectOptions"></div>
            </div>
        </div>

        <button id="generateLinkBtn" disabled>
            <span id="generateBtnText">Generate Join Link</span>
            <span id="generateSpinner" class="spinner" style="display: none;"></span>
        </button>

        <div id="existingRoleResult" class="result"></div>
        </div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://tsu-n8n.onrender.com/webhook/create-discord-class';
        const GET_ROLES_URL = 'https://tsu-n8n.onrender.com/webhook/get-discord-roles';
        const GENERATE_LINK_URL = 'https://tsu-n8n.onrender.com/webhook/generate-role-link';

        // Roles to exclude from the dropdown
        const EXCLUDED_ROLES = ['Admin', 'Instructor'];

        // Tab switching functionality
        const tabs = document.querySelectorAll('.tab');
        const tabPanels = document.querySelectorAll('.tab-panel');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                // Remove active class from all tabs and panels
                tabs.forEach(t => t.classList.remove('active'));
                tabPanels.forEach(panel => panel.classList.remove('active'));

                // Add active class to clicked tab
                tab.classList.add('active');

                // Show corresponding panel
                if (targetTab === 'create') {
                    document.getElementById('createPanel').classList.add('active');
                } else if (targetTab === 'existing') {
                    document.getElementById('existingPanel').classList.add('active');
                }
            });
        });

        // Basic HTTP Auth
        const AUTH_USER = 'tsu';
        const AUTH_PASS = 'tsu';

        // Check auth on page load
        if (!checkAuth()) {
            requestAuth();
        }

        function checkAuth() {
            const auth = sessionStorage.getItem('auth');
            if (!auth) return false;

            try {
                const decoded = atob(auth);
                return decoded === AUTH_PASS;
            } catch (e) {
                return false;
            }
        }

        function requestAuth() {
            const auth = prompt('Enter the password:');
            if (!auth) {
                document.body.innerHTML = '<div style="text-align:center;padding:40px;">Access Denied</div>';
                return;
            }

            if (auth === AUTH_PASS) {
                sessionStorage.setItem('auth', btoa(auth));
            } else {
                alert('Invalid credentials');
                requestAuth();
            }
        }

        // Input validation
        const form = document.getElementById('classForm');
        const classNameInput = document.getElementById('className');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnSpinner = document.getElementById('btnSpinner');
        const resultDiv = document.getElementById('result');
        const validationMessage = document.getElementById('validationMessage');

        // Validation regex: alphanumeric, spaces, hyphens, underscores only
        const validationRegex = /^[a-zA-Z0-9\s\-_]+$/;

        // Transform input to Discord resource names
        function transformNames(input) {
            // Title case for category and role
            const titleCased = input
                .trim()
                .split(/\s+/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');

            // Lowercase hyphenated for channel (then add -chat suffix)
            const channelName = input
                .toLowerCase()
                .trim()
                .replace(/ +/g, '-')
                .replace(/[^a-z0-9\-_]/g, '')
                + '-chat';

            return { titleCased, channelName };
        }

        classNameInput.addEventListener('input', (e) => {
            const value = e.target.value;
            const namePreview = document.getElementById('namePreview');

            if (value === '') {
                // Empty input - reset state
                classNameInput.classList.remove('valid', 'invalid');
                validationMessage.classList.remove('show');
                namePreview.style.display = 'none';
                submitBtn.disabled = true;
            } else if (validationRegex.test(value)) {
                // Valid input
                classNameInput.classList.remove('invalid');
                classNameInput.classList.add('valid');
                validationMessage.classList.remove('show');
                submitBtn.disabled = false;

                // Show name preview
                const names = transformNames(value);
                document.getElementById('categoryPreview').textContent = names.titleCased;
                document.getElementById('rolePreview').textContent = names.titleCased;
                document.getElementById('channelPreview').textContent = names.channelName;
                namePreview.style.display = 'block';
            } else {
                // Invalid input
                classNameInput.classList.remove('valid');
                classNameInput.classList.add('invalid');
                validationMessage.classList.add('show');
                namePreview.style.display = 'none';
                submitBtn.disabled = true;
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const className = classNameInput.value.trim();
            if (!className || !validationRegex.test(className)) return;

            // Show loading state
            submitBtn.disabled = true;
            btnText.textContent = 'Creating...';
            btnSpinner.style.display = 'inline-block';
            resultDiv.className = 'result';
            resultDiv.style.display = 'none';

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ className })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.style.display = '';

                    let html = `
                        <div class="result-title">‚úÖ Successfully created: ${data.className}</div>
                        <div class="result-content">
                            <p style="margin-bottom: 12px;"><strong>Discord Resources Created:</strong></p>
                            <ul class="resources-list">
                                <li>Category: ${data.category.name} (ID: ${data.category.id})</li>
                                <li>Channel: #${data.channel.name} (ID: ${data.channel.id})</li>
                                <li>Role: ${data.role.name} (ID: ${data.role.id})</li>
                            </ul>
                            ${data.warning ? `<p style="color: #ca8a04; font-weight: 600;">‚ö†Ô∏è ${data.warning}</p>` : ''}
                            <div class="oauth-url" id="oauthUrl">${data.oauthUrl}</div>
                            <button class="copy-btn" onclick="copyOAuthUrl(this)">
                                üìã Copy Join Link
                            </button>
                        </div>
                    `;

                    resultDiv.innerHTML = html;
                    classNameInput.value = '';
                    classNameInput.classList.remove('valid');
                    submitBtn.disabled = true;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.style.display = '';
                    // Clean up error message - remove n8n line number suffix
                    const cleanError = (data.error || 'An unexpected error occurred. Please try again.').replace(/\s*\[line \d+\]$/i, '');
                    resultDiv.innerHTML = `
                        <div class="result-title">‚ùå Error</div>
                        <div class="result-content">
                            <p>${cleanError}</p>
                            ${data.rollback ? `<p style="margin-top: 8px; font-style: italic;">${data.rollback}</p>` : ''}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.style.display = '';
                resultDiv.innerHTML = `
                    <div class="result-title">‚ùå Network Error</div>
                    <div class="result-content">
                        <p>Could not connect to the server. Please check your internet connection and try again.</p>
                    </div>
                `;
            } finally {
                // Reset button state (keep disabled until valid input)
                btnText.textContent = 'Create Discord Channel';
                btnSpinner.style.display = 'none';
            }
        });

        function copyOAuthUrl(btn) {
            const oauthUrl = document.getElementById('oauthUrl').textContent;
            navigator.clipboard.writeText(oauthUrl).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Copied to Clipboard!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Generate Link for Existing Role functionality
        const customSelect = document.getElementById('customSelect');
        const selectDisplay = document.getElementById('selectDisplay');
        const selectedRoleText = document.getElementById('selectedRoleText');
        const selectOptions = document.getElementById('selectOptions');
        const generateLinkBtn = document.getElementById('generateLinkBtn');
        const generateBtnText = document.getElementById('generateBtnText');
        const generateSpinner = document.getElementById('generateSpinner');
        const existingRoleResult = document.getElementById('existingRoleResult');

        let selectedRole = null;

        // Convert Discord color number to hex
        function colorToHex(color) {
            if (!color || color === 0) return '#99aab5'; // Default gray for no color
            return '#' + color.toString(16).padStart(6, '0');
        }

        // Load Discord roles on page load
        fetch(GET_ROLES_URL)
            .then(response => response.json())
            .then(roles => {
                selectOptions.innerHTML = '';

                // Filter out excluded roles (Admin, Instructor)
                const filteredRoles = roles.filter(role => !EXCLUDED_ROLES.includes(role.name));

                filteredRoles.forEach(role => {
                    const option = document.createElement('div');
                    option.className = 'select-option';
                    option.dataset.roleId = role.id;
                    option.dataset.roleName = role.name;
                    option.dataset.roleColor = colorToHex(role.color);

                    const colorDot = document.createElement('div');
                    colorDot.className = 'role-color-dot';
                    colorDot.style.backgroundColor = colorToHex(role.color);

                    const roleName = document.createElement('span');
                    roleName.textContent = role.name;

                    option.appendChild(colorDot);
                    option.appendChild(roleName);

                    option.addEventListener('click', () => {
                        selectedRole = {
                            id: role.id,
                            name: role.name,
                            color: colorToHex(role.color)
                        };

                        // Update display
                        selectedRoleText.innerHTML = '';
                        const displayDot = document.createElement('div');
                        displayDot.className = 'role-color-dot';
                        displayDot.style.backgroundColor = selectedRole.color;
                        displayDot.style.display = 'inline-block';
                        displayDot.style.verticalAlign = 'middle';
                        selectedRoleText.appendChild(displayDot);
                        selectedRoleText.appendChild(document.createTextNode(' ' + selectedRole.name));

                        // Close dropdown
                        selectOptions.classList.remove('open');
                        selectDisplay.classList.remove('open');

                        // Enable generate button
                        generateLinkBtn.disabled = false;
                    });

                    selectOptions.appendChild(option);
                });

                customSelect.classList.remove('disabled');
                selectedRoleText.textContent = 'Select a role...';
            })
            .catch(error => {
                selectedRoleText.textContent = 'Error loading roles';
                console.error('Error loading roles:', error);
            });

        // Toggle dropdown
        selectDisplay.addEventListener('click', () => {
            if (!customSelect.classList.contains('disabled')) {
                selectOptions.classList.toggle('open');
                selectDisplay.classList.toggle('open');
            }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!customSelect.contains(e.target)) {
                selectOptions.classList.remove('open');
                selectDisplay.classList.remove('open');
            }
        });

        // Generate link button click handler
        generateLinkBtn.addEventListener('click', async () => {
            if (!selectedRole) return;

            // Show loading state
            generateLinkBtn.disabled = true;
            generateBtnText.textContent = 'Generating...';
            generateSpinner.style.display = 'inline-block';
            existingRoleResult.className = 'result';
            existingRoleResult.style.display = 'none';

            try {
                const response = await fetch(GENERATE_LINK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ roleId: selectedRole.id })
                });

                const data = await response.json();

                if (data.success) {
                    existingRoleResult.className = 'result success';
                    existingRoleResult.style.display = '';
                    const cachedNote = data.cached ? ' <span style="color: #ca8a04;">(from cache)</span>' : '';
                    existingRoleResult.innerHTML = `
                        <div class="result-title">‚úÖ Join Link Generated: ${data.roleName}${cachedNote}</div>
                        <div class="result-content">
                            <p style="margin-bottom: 12px;"><strong>Share this link with students to grant them access:</strong></p>
                            <div class="oauth-url" id="existingOauthUrl">${data.oauthUrl}</div>
                            <button class="copy-btn" onclick="copyExistingOAuthUrl(this)">
                                üìã Copy Join Link
                            </button>
                        </div>
                    `;
                } else {
                    existingRoleResult.className = 'result error';
                    existingRoleResult.style.display = '';
                    existingRoleResult.innerHTML = `
                        <div class="result-title">‚ùå Error</div>
                        <div class="result-content">
                            <p>${data.error || 'An unexpected error occurred. Please try again.'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                existingRoleResult.className = 'result error';
                existingRoleResult.style.display = '';
                existingRoleResult.innerHTML = `
                    <div class="result-title">‚ùå Network Error</div>
                    <div class="result-content">
                        <p>Could not connect to the server. Please check your internet connection and try again.</p>
                    </div>
                `;
            } finally {
                // Reset button state
                generateBtnText.textContent = 'Generate Join Link';
                generateSpinner.style.display = 'none';
                generateLinkBtn.disabled = false;
            }
        });

        function copyExistingOAuthUrl(btn) {
            const oauthUrl = document.getElementById('existingOauthUrl').textContent;
            navigator.clipboard.writeText(oauthUrl).then(() => {
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Copied to Clipboard!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            });
        }
    </script>
</body>
</html>
